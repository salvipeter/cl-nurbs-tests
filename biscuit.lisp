(in-package :cl-nurbs-tests)

(defun read-lop (filename)
  (flet ((read-array (s &optional d)
           (let ((n (read s)))
             (iter (repeat n)
                   (collect (if d
                                (iter (repeat d) (collect (read s)))
                                (read s)))))))
    (with-open-file (s filename)
      (let ((n (read s)))
        (iter (repeat n)
              (for degree = (read s))
              (for knots = (read-array s))
              (for cpts = (read-array s 3))
              (collect (make-bspline-curve degree knots cpts)))))))

(defvar *biscuit-breadth*)

(defun generate-biscuit (curve prev next filename)
  "Assumes that all curves are parameterized in [0,1]."
  (let* ((prev-d (vnormalize (bsc-evaluate prev 1 :derivative 1)))
         (next-d (vnormalize (bsc-evaluate next 0 :derivative 1)))
         (start-d (vnormalize (bsc-evaluate curve 0 :derivative 1)))
         (end-d (vnormalize (bsc-evaluate curve 1 :derivative 1)))
         (n1 (cross-product prev-d start-d))
         (n2 (cross-product end-d next-d)))
    (flet ((normal (u)
             (v+ (v* n1 (hermite-blend-function 'point 'start u))
                 (v* n2 (hermite-blend-function 'point 'end u))))
           (collect-fan (p n d)
             (iter (for i from 1 below *resolution*)
                   (for phi = (* (/ i *resolution*) pi))
                   (for b = (cross-product d n))
                   (for dir = (v+ (v* b (cos phi)) (v* d (sin phi))))
                   (collect (v+ p (v* dir *biscuit-breadth*))))))
      (let ((side (iter (for i from 0 to *resolution*)
                        (for u = (/ i *resolution*))
                        (for n = (normal u))
                        (for p = (bsc-evaluate curve u))
                        (for d = (vnormalize (bsc-evaluate curve u :derivative 1)))
                        (for dir = (cross-product n d))
                        (collect p)
                        (collect (v+ p (v* dir *biscuit-breadth*)))
                        (collect (v- p (v* dir *biscuit-breadth*)))))
            (start (collect-fan (bsc-evaluate curve 0) n1 (v* start-d -1)))
            (end (collect-fan (bsc-evaluate curve 1) n2 end-d)))
        (with-open-file (s filename :direction :output :if-exists :supersede)
          (dolist (p (append side start end))
            (format s "v纩ア皓ㄦ戾è痨躞祗忉箦磲疸狎灬礅溽ǐ忉箦┅祗舂ㄦ犷趄獒铉戾ㄢ狍骈蝮灬篝ㄦ矧磲㈡濑ア骈蝮ǐ忉箦┅ㄩ翦ㄦ矧骝镯忮祜蝈箫祯糸镱ㄦ矧磲㈡濑アǐ忉箦ǐ忉箦┅ㄦ矧磲㈡濑アǐū蝈箫祯糸镱忉箦灬篝┅ㄩ翦ㄦ矧骝镯忮祜í蝈箫祯糸镱怡畅ㄦ矧磲㈡濑ア痨躞Ж穿椹ㄦ矧磲㈡濑ア痨躞Ж穿椹ㄦ矧磲㈡濑ア痨躞Ж旦椹ㄦ矧磲㈡濑ア痨躞Ж穿椹┅戾è铕镩铘íū蝈箫祯糸镱┅┅ㄦ犷趄獒铉戾铕镩铘畅ㄦ犷趄獒铉戾ǐ铕镩铘蝈箫祯糸镱暴ō铕镩铘博铕镩铘ū铕镩铘螬┅┅┅┅ㄤ彐躅珏铄蜥翦忾筱蹰趔骝镯祜ㄦ殪孱犴秕麴豸痱彐轼戾è沲蝣弩蝈徜祜骈戾钺礤┅ㄩ翦鏖翳戾铉翳沲蝣弩┅ㄦ矧骝镯忮祜瞟ㄦ矧钺礤ㄦ矧磲铋岘岙镡辎秕麴豸痱彐轼ū椹┅ㄦ矧轫盹ū椹瞟ㄦ矧轲盹ū椹瞟ㄧ孱弪狒瀛忾筱蹰ㄥ祠沲蝣弩椹ㄥ祠沲蝣弩轫ㄥ祠沲蝣弩轲钺礤┅┅＋铋戾è蝈箫祯糸镱蛋í忾筱蹰舡怛遽漪瑾卑┅ㄧ孱弪狒瀛忾筱蹰趔骝镯祜栾礤筢祧榀痱镪邈舣箬狃屮趄犷箧轭轸瀵盹溴祗汜玟付祜稷繇鸠汜玟付┅